# Physically Based Shading

물리 기반 셰이딩은 새로운 것이 아니라 하드웨어의 발전에 따라 계산 능력에 여유가 생겨 이전에는 고려하지 못했던 빛의 물리적 성질을 고려하게 된 것.



## 빛

빛의 전자기파의 일종.

![][01]

렌더링에서는 관심을 갖는 전자기파 범위는 파장이 380nm ~ 750nm 인 구간으로 이 구간을 가시광선이라고 함.

빛의 **전자기파의 일종**이기 때문에 **파동 성질**을 띔. 빛의 파동 성질을 가장 잘 설명하는 것이 바로 빛의 회절.

![][02]

또한 **광전효과**( 금속 표면에 특정 진동수 이상의 빛을 비추었을 때 전자가 튀어나오는 현상 )를 통해 아인슈타인이 **빛의 입자적 성질**을 가지고 있음을 설명하였음.

![][03]

즉 빛은 파동성과 입자성을 둘 다 띄고 있는데 이를 **빛의 이중성**이라고 함.



## 기하 광학( Geometrical optics )

물리적인 빛은 파동성과 입자성을 띄지만 렌더링에서는 이를 매우 단순화해서 다룸.

기하 광학은 **광선(ray)의 관점에서 광전파를 설명**하는 광학 모델로 특정 상황에서 빛이 전파되는 경로를 근사하는데 유용함.

기하 광학에서는 다음과 같이 가정하여 빛을 단순화 함.

> https://en.wikipedia.org/wiki/Geometrical_optics

- 균일 한 매체에서는 직선 경로로 전파.
- 두 개의 서로 다른 매체 사이의 인터페이스에서 구부러지고 갈라질 수 있음.
- 굴절률이 변화하는 매체에서는 굴곡된 경로를 따름.
- 흡수되거나 반사될 수 있음.

![][04]



##  빛의 다른 성질

반사외에도 빛에는 다양한 성질이 존재.

빛이 표면에 부딪히면 **일부는 흡수되고 일부는 반사되며 일부는 굴절**.

표면이 **특정한 색을 띄는 이유는 빛의 흡수** 때문.

우리가 **표면을 볼 수 있는 것은 빛이 반사**되기 때문.

게임에서는 주로 반사되는 빛에 관심을 가지는데 빛이 표면에 부딪혔을 때 반사만 일어나지 않기 때문에 보다 현실에 가까운 렌더링을 위해서 **반사되는 빛의 양을 추적하는 것이 중요**.

빛의 반사량을 추적하려면 빛이 얼마나 들어왔는지 측정해야 하는데 입사광은 다음과 같이 특**정지점을 둘러싼 반구로 부터 들어오는 것을 측정**함.

![][06]

이 반구는 표면의 법선 벡터를 기준으로 둘러싼 구의 반쪽 부분임.

물이 담긴 투명한 컵에 젓가락을 넣었을 때 **젓가락이 구불어져 보이는 것은 굴절** 때문.

빛은 균일한 매질을 통과하는 한 직선 경로를 유지하지만 매질을 들어오거나 빠져나가는 순간 경로가 휨. 경로가 휘는 정도는 매질의 굴절률의 차이에 따라 결정.

![][07]

굴절 방향은 보통 스넬의 법칙을 사용해 계산하는데 물 또는 유리와 같이 빛을 분명하게 굴절시키는 재질이 아니라면 이를 다루지 않을 것임.

굴절은 재질이 금속인지 비금속인지에 따라 조금 다른 양상을 보임.

금속은 굴절된 빛을 흡수함 따라서 금속에는 디퓨즈 요소가 매우 적음.

```hlsl
inline half OneMinusReflectivityFromMetallic(half metallic)
{
    // We'll need oneMinusReflectivity, so
    //   1-reflectivity = 1-lerp(dielectricSpec, 1, metallic) = lerp(1-dielectricSpec, 0, metallic)
    // store (1-dielectricSpec) in unity_ColorSpaceDielectricSpec.a, then
    //   1-reflectivity = lerp(alpha, 0, metallic) = alpha + metallic*(0 - alpha) =
    //                  = alpha - metallic * alpha
    half oneMinusDielectricSpec = unity_ColorSpaceDielectricSpec.a;
    return oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;
}

inline half3 DiffuseAndSpecularFromMetallic (half3 albedo, half metallic, out half3 specColor, out half oneMinusReflectivity)
{
    specColor = lerp (unity_ColorSpaceDielectricSpec.rgb, albedo, metallic);
    oneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);
    return albedo * oneMinusReflectivity;
}
```

비금속 재질은 빛이 흡수되거나 재질을 다시 빠져나갈때 까지 **표면 아래를 산란**함. 따라서 빛이 다시 빠져나가는 위치는 빛이 들어온 위치와 다르게 됨.

**디퓨즈 근사는 이것을 무시하여 빛이 들어온 지점이 나가는 지점과 동일하다고 가정**함.

빛이 들어온 위치와 나가는 위치가 다른 경우를 시뮬레이션 하기 위해서는 **서브서피스 스케터링(Subsurface Scattering)** 을 사용할 필요가 있음.

![][08]



## 프레넬 반사율

프레넬 반사율은 입사한 빛의 세기에 대해 얼마만큼 반사했는지의 비율을 나타낸 값임.

![][09]

보통 프레넬 반사율은 슐릭(Schlick)의 근사식을 통해서 코드로 구현함.

![][10]



## 빛의 측정하는 방법

물리에서 빛을 측정하는 방법은 2가지가 있음.

1. Radiometry : 전자기파의 전자기적 복사에너지를 측정하는 것.
2. Photometry : 전자기적 복사 에너지중에 인간의 눈으로 감지할 수 있는 범위의 빛(light)을 측정하는 것.

렌더링 방정식을 해석하려면 각 측정 방식에 관련된 측정 단위를 알아야 함.



### 입체각(Solid Angle)

입체각은 스테라디안(steradian) 이라는 단위로 표현하고 기호는 sr임. 입체각은 2차원의 각을 3차원으로 확장한 것으로 라디안을 정의할 때 반지름과 호의 길이를 이용한 것 처럼 스테라디안은 반지름과 구 표면의 면적을 이용함.

즉 1 라디안은 **반지름이 r인 원에서 호의 길이가 r일 때**를 나타내는 단위이고

![][11]

1 스테라디안은 이를 확장하여 반지름이 r인 구에서 구 표면의 면적이 r^2일 때를 나타냄.

![][12]



### Radiometry

#### Radiant Flux

Radiant Flux 혹은 Radiant Power는 단위 시간당 방사, 반사되어 전달되는 방사 에너지(Radiant energy). 단위는 와트(W).

![][13]

#### Radiant Intensity

Radiant Intensity 는 단위 입체각당 방사, 반사되어 전달되는 Radiant Flux. 단위는 스테라디안당 와트 (W/sr).

![][14]

#### Irradiance

Irradiance는 단위 표면이 받는 Radiant Flux의 양 단위는 제곱미터당 와트(W/m^2)

![][15]

#### Radiance

Radiance는 어떤 표면의 특정 방향의 사영된 단위 면적에 대한 단위 입체각 당 Radiant Flux로 단위는 제곱미터 당 단위각 당 와트( W/M^2 * SR )

![][16]

![][17]



### 번외 : Photometry

Photometry에서도 Radiometry에서 살펴본것과 동일한 단위가 존재함.

#### Luminous flux

Radiometry에서의 Radiant Flux에 해당. 단위는 루멘(lumen = candela * steradians)



#### Luminous Intensity

Radiometry에서의 Radiant Intensity에 해당. 단위는 칸델라(candela)



#### Illuminance

Radiometry에서의 Irradiance에 해당. 단위는 럭스(lux)



#### luminance

Radiometry에서의 Radiance에 해당. 단위는 제곱미터 당 칸델라 (cd/m^2)



## 양방향 반사 분포 함수(BRDF)

양방향 반수 분포 함수는 빛이 표면에서 어떻게 반사될지를 정의한 함수.

램버트, 퐁과 같은 라이팅 모델은 BRDF임.

BRDF는 반사에만 관심을 갖기 때문에 표면하 산란이나 반투명현상을 표현하지 못함.

![][18]

BRDF 함수는 **들어오는 빛의 방향 벡터**와 **반사되는 빛의 방향 벡터**를 인자로 취함.

인자들은 구형좌표계의 형태로 되어 있기 때문에 2개의 숫자로 하나의 방향을 나타낼 수 있음.

대체적으로 **쎄타는 천정각**을 의미하고 **파이는 방위각**을 의미함.

![][19]

BRDF는 어떤 단위 표면에 들어오는 빛의 총량 대비 특정 방향으로 반사되는 빛의 총량으로 정의됨.

![][20]

물리기반의 BRDF가 만족해야 하는 성질이 있음.

1. 양성
   BRDF는 음수를 가질 수 없음. 음의 빛은 존재하지 않음.

2. 상반성
   방향 인자를 서로 뒤바꿔도 결과 값은 변하지 않음.

3. 에너지 보존
   물체 자체에서 빛을 발산하지 않으면 나가는 빛은 들어온 빛의 총량을 넘을 수 없음. 즉 들어온 빛이 1이라면 나가는 빛은 1과 같거나 작아야 함.



## 미세면 이론

미세면 이론은 표면이 여러개의 미세한 요철로 구성되어 있다고 생각하는 이론

![][05]

미세면은 하나의 법선에 따라 광선을 하나의 방향으로 반사함.

미세면 이론을 통해서 실제 메시를 복잡하게 구성하지 않아도 복잡한 표면에 대한 반사를 통계를 통해서 근사할 수 있음.

미세면 이론중에 **쉐도잉(Shdowing)**과 **마스킹(Masking)**을 살펴볼 필요가 있음.

쉐도잉과 마스킹은 미세면에 의한 빛의 차폐 현상으로 그림으로 살펴보면 다음과 같음.

![][21]

쉐도잉과 마스킹은 실제 빛의 동작을 매우 근사한 것으로 단 한번의 반사만을 고려하고 있음. 실제로는 빛이 계속 반사하다가 표면을 빠져나가게 되지만 이를 고려하지 않음.

미세면 스펙큘러 BRDF는 이런 이론을 바탕으로 유도되었는데 다음과 같음.

![][22]

### 프레넬

앞에서 이야기 했듯. 빛이 얼마나 반사되는지를 나타냄. 프레넬 공식이 여기서 사용됨.

### 기하 함수

쉐도잉과 마스킹에 의해 빛이 얼마나 차폐되는지를 알려줌.

### 정규 분포 함수

얼마나 많은 미세면이 반각 벡터를 향하는지 알려줌. 일반적으로 사용되는 정규 분포 함수에는 GGX, 블린 퐁, 벡맨등이 있음.



## 렌더링 방정식

이제 렌더링 방정식을 살펴볼 수 있음.

![][23]

![][24]는 나가는 빛으로 이 방정식을 통해서 구하고자 하는 값임.

![][25]는 표면에서 발산(emit) 되는 빛임. 이것은 적분식 밖에 있으므로 한번만 더해주면 됨.

![][26]는 적분식으로 여기서 오메가는 반구를 나타냄.

![][27]는 BRDF 함수.

![][28]은 오메가 i 방향에서 들어오는 빛을 나태냄.

마지막으로 ![][29]는 입사각에 따른 감쇠항으로 입사각에 따라 빛을 받게되는 면적이 늘어나는 것을 고려한 것임.



## 실시간 렌더링에 필요한 것들

렌더링 방정식의 적분 부분은 아직까지 실시간으로 처리할 수 없음. 간접광은 **구면 조화(Spherical Harmonics),  광역 조명(Global Illumiantion), 라이트 매핑(Light mapping), 이미지 기반 라이팅( 반사 프로브, 큐브맵 )**의 다양한 테크닉을 통해 처리해야 함.



## HDR 과 톤매핑

색을 표현하는데 4바이트의 자료형은 사실적이지 않음. HDR은 내부적으로 좀 **더 많은 단계를 갖는 부동 소수점 데이터를 이용해서 디스플레이 장치가 표현할 수 있는 것 보다 더 크거나 작은 밝기 값을 세밀하게 표시**할 수 있도록 하는 것임.

톤매핑은 HDR에서 사용한 넓은 공간의 값을 디스플레이 장치가 표현할 수 있는 공간으로 매핑하는 기법을 의미함.



## 선형 색상 공간

눈의 망막에는 시세포가 있어 빛의 자극을 통해 사물을 볼 수 있음. 

시세포는 **원추 세포**와 **간상 세포**로 나뉠 수 있는데 **원추 세포는 색상을 감지**하고 **간상 세포는 약한 빛을 감지**.

간상 세포는 한 개의  광자에도 반응할 만큼 예민함. 즉 인간의 눈은 밝은 빛의 변화보다 약한 빛의 변화에 민감함.

색을 표현하는데 사용되는 용량은 한정적. 그렇다면 그 공간을 최대한 효율적으로 사용할 필요가 있음. 따라서 **어두운 부분의 변화를 세밀하게 저장**하고 **밝은 부분은 덜 세밀하게 저장**해야 함.

따라서 다음과 같이 어두운 색에서는 느리게 변하고 밝은 색에서는 가파르게 변하도록 저장함.

![][30]

이것을 감마 인코딩(Gamma Encoding) 이라고 함

이렇듯 컴퓨터에 저장된 대부분의 색상 데이터는 왜곡되어 있기 때문에 이를 선형 공간(Linear Space)으로 변경하여 조명 계산을 할 필요성이 있음.

```hlsl
inline float GammaToLinearSpaceExact (float value)
{
    if (value <= 0.04045F)
        return value / 12.92F;
    else if (value < 1.0F)
        return pow((value + 0.055F)/1.055F, 2.4F);
    else
        return pow(value, 2.2F);
}

inline float LinearToGammaSpaceExact (float value)
{
    if (value <= 0.0F)
        return 0.0F;
    else if (value <= 0.0031308F)
        return 12.92F * value;
    else if (value < 1.0F)
        return 1.055F * pow(value, 0.4166667F) - 0.055F;
    else
        return pow(value, 0.45454545F);
}
```







[01]: ./Img/08/01.png
[02]: ./Img/08/02.gif
[03]: ./Img/08/03.png
[04]: ./Img/08/04.png
[05]: ./Img/08/05.png
[06]: ./Img/08/06.png
[07]: ./Img/08/07.png
[08]: ./Img/08/08.png
[09]: ./Img/08/09.jpg
[10]: ./Img/08/10.png
[11]: ./Img/08/11.gif
[12]: ./Img/08/12.png
[13]: ./Img/08/13.png
[14]: ./Img/08/14.png
[15]: ./Img/08/15.png
[16]: ./Img/08/16.png
[17]: ./Img/08/17.png
[18]: ./Img/08/18.png
[19]: ./Img/08/19.gif
[20]: ./Img/08/20.png
[21]: ./Img/08/21.png
[22]: ./Img/08/22.png
[23]: ./Img/08/23.png
[24]: ./Img/08/24.png
[25]: ./Img/08/25.png
[26]: ./Img/08/26.png
[27]: ./Img/08/27.png
[28]: ./Img/08/28.png
[29]: ./Img/08/29.png
[30]: ./Img/08/30.png